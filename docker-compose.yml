version: "1"

services:
  # 1. MySQL 데이터베이스 서비스
  db:
    # MySQL 8.0 공식 이미지 사용
    image: mysql:8.0
    # 컨테이너 이름 지정 (선택 사항)
    container_name: mysql-db-80
    restart: always

    # 💡 새로운 Health Check 섹션 추가
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s # 처음 10초 동안은 실패해도 무시

    # 환경 변수 설정
    environment:
      # root 계정 패스워드 설정 (요청: 1234)
      MYSQL_ROOT_PASSWORD: 1234
      # 초기 DB명 설정 (요청: edudb)
      MYSQL_DATABASE: edudb
      # 새로운 사용자 계정/패스워드 설정 (요청: jdbctest/jdbctest)
      MYSQL_USER: jdbctest
      MYSQL_PASSWORD: jdbctest
      # 중요: 이 설정은 개발/테스트 환경에서만 사용해야 합니다.
      # Docker Compose가 DB 컨테이너 시작 후 바로 Spring Boot 앱이 시작될 수 있도록
      # 초기화 지연 시간을 최소화합니다.
      # 이 설정 없이는 Spring Boot가 DB가 완전히 준비되기 전에 연결을 시도할 수 있습니다.
      # healthcheck를 사용하는 것이 더 안전하지만, 여기서는 간결한 환경 변수를 사용했습니다.
      # 다른 환경에서는 이 설정을 제거하거나 다른 방법(Wait-For-It 등)을 사용해야 합니다.
      MYSQL_INITDB_SKIP_TZINFO: "true"

    # 포트 매핑 (호스트 포트:컨테이너 포트)
    # 3306 포트를 호스트에 노출하여 외부 툴(DBeaver 등)로 접속 가능하게 함.
    # Spring Boot의 자동 연결 기능을 사용하려면 이 포트 매핑을 생략하거나 랜덤 포트로 설정해도 무방합니다.
    ports:
      - "3306:3306"

    # 데이터 영속성을 위한 볼륨 설정 (컨테이너 삭제 후에도 데이터 유지)
    volumes:
      - mysql_data:/var/lib/mysql

  # 2. Spring Boot 애플리케이션 서비스

  app:
    # 도커 이미지 파일명/태그. (미리 jar 파일로 빌드되어 있어야 함)
    # Dockerfile을 사용해 jar 파일을 컨테이너화하는 과정이 필요합니다.
    # 예시: spring-cicd-app:latest
    build:
      context: .
      dockerfile: Dockerfile

    # 컨테이너 이름 지정
    container_name: spring-boot-app

    # Spring Boot 애플리케이션이 외부로 노출할 포트 (요청: 8888)
    # 호스트 8088 포트와 컨테이너 내부 8888 포트 매핑
    ports:
      - "8888:8888"

    # 'db' 서비스가 완전히 실행된 후 'app' 서비스가 시작되도록 보장
    depends_on:
      db:
        condition: service_healthy

    # 환경 변수 (선택 사항)
    # Spring Boot 3.1+의 Docker Compose 지원 기능을 사용하면
    # 데이터소스 설정은 자동으로 처리됩니다. (connection: mysql://db:3306...)
    #environment:
    #  SPRING_PROFILES_ACTIVE: prod

# 데이터 영속성을 위한 볼륨 정의

volumes:
  mysql_data: